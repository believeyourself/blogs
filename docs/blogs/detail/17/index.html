<!--
 * @Date: 2022-01-20 14:27:07
 * @LastEditors: lzj
 * @LastEditTime: 2022-01-21 16:41:33
 * @FilePath: \qianduan.shop\front\src\pages\document.ejs
--><!DOCTYPE html><html><head><title data-react-helmet="true">node事件循环（Event loop） - 前端网</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2087076429727327" crossorigin="anonymous"></script>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="/umi.css">
    <link rel="stylesheet" href="/layouts.chunk.css">
    <link rel="stylesheet" href="/p__blogs__detail__detail.chunk.css">
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.18
    </script>
    <title>文章详情</title>
  <meta data-react-helmet="true" name="description" content="node,事件循环,本文将简述浏览器中的js事件循环机制，帮助我们理解Node中代码是如何运行的。Javascript的一大特点是单线程，也就意味着同一时间他只能做一件事。那Node是如何支撑高并发呢？"><meta data-react-helmet="true" name="keywords" content="node,事件循环">
</head>

  <body>
    <div id="root"><header class="header___2_57M"><img alt="farmerLZJ" class="title___MhkPP" src="/static/logo.68ff92ec.png"/></header><div style="width:100%;position:relative;top:0;z-index:999"><nav class="nav___3wfA1"><a href="https://izejun.com/blogs" class="item___AqKVH active___1THnk">Blog</a></nav></div><div class="content___2QN8t"><div class="content___1G4Bw"><article><h1>node事件循环（Event loop）</h1>

<p>本文将简述node事件循环的机制，帮助我们理解node环境中代码是如何运行的。</p>

<h2>1.node运行机制</h2>

<p>node使用V8作为js解析引擎，I/O处理使用了自己设计的libuv,libuv是一个基于事件的跨平台抽象层，封装了不同操作系统一些底层特性，对外提供统一的API,事件循环机制也是它里面的实现。</p>

<p>运行机制： </p>

<p>① V8引擎解析JavaScript脚本。 </p>

<p>② 解析后的代码，调用Node API。 </p>

<p>③ libuv库负责Node API的执行。它将不同的任务分配给不同的线程，形成一个Event Loop（事件循环），以异步的方式将任务的执行结果返回给V8引擎。 </p>

<p>④ V8引擎再将结果返回给用户。 </p>

<h2>2.事件循环</h2>

<p>libuv引擎中的事件循环分为 6 个阶段，循环运行。 </p>

<p>每个阶段都有一个 FIFO 队列来执行回调。每当进入新阶段的时候，都会从对应的回调队列中取出函数去执行，当队列为空或者执行的回调数量到达系统设定的阈值，就会进入下一阶段。</p>

<p>流程如下： </p>

<p><code></code>`</p>

<p>   ┌───────────────────────────┐
┌─&gt;│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │&lt;─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘</p>

<p><code></code>`</p>

<p>① 定时器(timers)：本阶段执行已经被 setTimeout() 和 setInterval() 的回调函数。</p>

<p><strong>注意：轮询阶段控制何时定时器执行。</strong>轮询阶段回调队列执行完毕后，node会检查是否有定时器到期，如果有，则回到timers阶段执行定时器回调，所以定时器的执行时间不是确定的，定时器有可能被轮询阶段正在执行的回调阻塞导致延迟，node只保证保证尽快执行。</p>

<p>② 待定回调(pending callbacks)：执行延迟到下一个循环迭代的 I/O 回调。  </p>

<p>此阶段对某些系统操作（如 TCP 错误类型）执行回调。例如，如果 TCP 套接字在尝试连接时接收到 ECONNREFUSED，则某些 *nix 的系统希望等待报告错误。这将被排队以在 挂起的回调 阶段执行。</p>

<p>③ idle, prepare：仅系统内部使用。 </p>

<p>④ 轮询(poll)：检索新的 I/O 事件;执行与 I/O 相关的回调（几乎所有情况下，除了关闭的回调函数，那些由计时器和 setImmediate() 调度的之外），其余情况 node 将在适当的时候在此阻塞。 </p>

<p>轮询 阶段有两个重要的功能：</p>

<p>1.计算应该阻塞和轮询 I/O 的时间。 </p>

<p>2.接着，处理轮询队列里的事件。 </p>

<p>当事件循环进入轮询阶段且没有被调度的计时器时，将发生以下两种情况之一：</p>

<pre><code>1)如果轮询队列不是空的 ，事件循环将循环访问回调队列并同步执行它们，直到队列已用尽，或者达到了与系统相关的硬性限制。

2)如果轮询队列是空的 ，还有两件事发生：

    如果脚本被 setImmediate() 调度，则事件循环将结束 轮询 阶段，并继续 检查 阶段以执行那些被调度的脚本。

    如果脚本未被 setImmediate() 调度，则事件循环将等待回调被添加到队列中，然后立即执行。</code></pre>

<p>一旦 轮询 队列为空，事件循环将检查 <em>已达到时间阈值的计时器</em>。如果一个或多个计时器已准备就绪，则事件循环将绕回计时器阶段以执行这些计时器的回调。</p>

<p>⑤ 检测(check)：setImmediate() 回调函数在这里执行。 </p>

<p>⑥ 关闭的回调函数(close callbacks )：一些关闭的回调函数，如：socket.on(&#39;close&#39;, ...)。</p>

<p>如果套接字或处理函数突然关闭（例如 socket.destroy()），则&#39;close&#39; 事件将在这个阶段发出。否则它将通过 process.nextTick() 发出。</p></article><div><span class="ant-tag ant-tag-geekblue">#<span>node</span></span><span class="ant-tag ant-tag-volcano">#<span>事件循环</span></span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><ins class=" adsbygoogle" style="display:block;text-align:center;width:100%;height:90px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="9331479126" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="container___8WoUM"><p class="title___3k8xL">Online Tools</p><div class="tool_tags___1ccK5"><span class="ant-tag ant-tag-blue tool_tag___1JT6M">JSON Formater</span><span class="ant-tag ant-tag-cyan tool_tag___1JT6M">MD5</span><span class="ant-tag ant-tag-error tool_tag___1JT6M">timestamps</span><span class="ant-tag ant-tag-green tool_tag___1JT6M">Cron Expresstion</span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div></div></div><footer class="footer___3wR6c">©2021 farmerlzj 提供技术支持 | 联系我们：farmerlzj@163.com |<!-- --> <a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">蜀ICP备2021025378号-1</a></footer><div class="ant-back-top"></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="https://cloud.qianduan.shop/react.min.js"></script>
    <script src="https://cloud.qianduan.shop/react-dom.min.js"></script>
    <script src="/umi.js"></script>
    <script src="/layouts.js"></script>
    <script src="/p__blogs__detail__detail.js"></script>
  

</body></html>