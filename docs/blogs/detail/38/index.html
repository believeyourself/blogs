<!DOCTYPE html><html><head><title data-react-helmet="true">升级 egg-socket.io 到 4.4.0  - 前端网</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="baidu-site-verification" content="code-TlaecuFEx5">
    <meta name="sogou_site_verification" content="wMb3kHjFi6">
    <meta name="shenma-site-verification" content="19dfe33fcd6f20294164ba6738d0e102_1634534936">
    <meta name="360-site-verification" content="e943e2d7714355d2d1af8f36b12c41f9">
    <meta name="baidu_union_verify" content="6f7381d4136832e99f86da0d67739a46">
    <meta name="bytedance-verification-code" content="d+FL9L0/4KxPwFbqXgmT">

    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2087076429727327"
    crossOrigin="anonymous"></script> -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="/umi.css">
    <link rel="stylesheet" href="/layouts.chunk.css">
    <link rel="stylesheet" href="/p__blogs__detail__detail.chunk.css">
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.18
    </script>
    <title>文章详情</title>
  <meta data-react-helmet="true" name="description" content="前端网,node,egg,socket.io,版本升级,阿里这个框架已经很久没更新了，连插件模块都没有人维护。本来想着用 egg-socket.io 的 2.1.1 版本就行了，但是用起来发现很多的 api 都用不了了，于是有了升级的想法，重写配置。"><meta data-react-helmet="true" name="keywords" content="前端网,node,egg,socket.io,版本升级">
</head>

  <body>
    <div id="root"><header class="header___2_57M"><img alt="farmerLZJ" class="title___MhkPP" src="/static/logo.68ff92ec.png"/></header><div style="width:100%;position:relative;top:0;z-index:999"><nav class="nav___3wfA1"><a href="https://izejun.com/blogs" class="item___AqKVH active___1THnk">博客</a></nav></div><div class="content___2QN8t"><div class="content___1G4Bw"><header><a href="https://izejun.com/" class="back___26SyS undefined"> <!-- -->首页</a> <!-- -->/<a href="https://izejun.com/blogs" class="back___26SyS undefined"> <!-- -->博客</a></header><article><h1>升级 egg-socket.io 到 4.4.0</h1>

<p>阿里这个框架已经很久没更新了，连插件模块都没有人维护。本来想着用 egg-socket.io 的 2.1.1 版本就行了，但是用起来发现很多的 api 都用不了了，于是有了升级的想法，重写配置。</p>

<p>本文记录了升级及修改配置的步骤供大家参考。</p>

<h2>升级包</h2>

<p><code>
npm uninstall socket.io redis-adapter redis
npm install socket.io@4.4.0 @socket.io/redis-adapter@7.1.0 ioredis --save
</code></p>

<p>就这么简单，因为从 redis 的适配器更名了，既然用最新版本，也都跟上吧，不过 redis 最新的 4 测试好像有问题，懒得折腾，直接上 ioredis。</p>

<h2>改配置</h2>

<p>因为我们更换了包，所以需要到对应的文件夹把包换一下</p>

<p><code>
- const redis = require(&#39;socket.io-redis&#39;);
+ const { createAdapter } = require(&#39;@socket.io/redis-adapter&#39;);
+ const Redis = require(&#39;ioredis&#39;);
</code></p>

<p>然后找到代码</p>

<p><code>
if (config.redis) {
</code></p>

<p>修改如下内容：</p>

<p><code></code>`
-    const adapter = redis(config.redis);
-    // https://github.com/socketio/socket.io-redis/issues/21
-    adapter.prototype.on(&#39;error&#39;, err =&gt; {
-      app.coreLogger.error(err);
-    });
-    app.io.adapter(adapter);
+    const pubClient = new Redis(config.redis);
+    const subClient = pubClient.duplicate();
+    pubClient.on(&#39;error&#39;, err =&gt; {
+      app.coreLogger.error(err);
+    });
+    subClient.on(&#39;error&#39;, err =&gt; {
+      app.coreLogger.error(err);
+    });
+    config.adapter = {
+      key: config.adapter?config.adapter.key:undefined,
+      requestsTimeout: config.adapter?config.adapter.requestsTimeout:5000,
+      publishOnSpecificResponseChannel: config.adapter?config.adapter.requpublishOnSpecificResponseChannel: false
+    }
+    app.io.adapter(createAdapter(pubClient, subClient,config.adapter));</p>

<p><code></code>`</p>

<p>这里加了一个 adapter 的参数，这是为了可以定制适配器。</p>

<h2>使用</h2>

<p>因为我没有把代码发成包，所以我直接把代码拷贝到项目底下</p>

<p>在项目根目录中新建一个plugins文件夹，把插件拷贝到该目录下，然后修改app/config/plugin.js
<code>
{
  io:{
    enable: true,
    package: &quot;../../plugins/egg-socket.io&quot;
  }
}
</code></p>

<p>这样就可以使用 4.4.0 版本了。</p></article><div><span class="ant-tag ant-tag-geekblue">#<span>node</span></span><span class="ant-tag ant-tag-volcano">#<span>egg</span></span><span class="ant-tag ant-tag-error">#<span>socket.io</span></span><span class="ant-tag ant-tag-success">#<span>版本升级</span></span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><ins class=" adsbygoogle" style="display:block;text-align:center;width:100%;height:90px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="9331479126" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="container___8WoUM"><p class="title___3k8xL">Online Tools</p><div class="tool_tags___1ccK5"><span class="ant-tag ant-tag-blue tool_tag___1JT6M">JSON Formater</span><span class="ant-tag ant-tag-cyan tool_tag___1JT6M">MD5</span><span class="ant-tag ant-tag-error tool_tag___1JT6M">timestamps</span><span class="ant-tag ant-tag-green tool_tag___1JT6M">Cron Expresstion</span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div></div></div><footer class="footer___3wR6c">©2021 farmerlzj 提供技术支持 | 联系我们：farmerlzj@163.com |<!-- --> <a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">蜀ICP备2021025378号-1</a></footer><div class="ant-back-top"></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="https://cloud.qianduan.shop/react.min.js"></script>
    <script src="https://cloud.qianduan.shop/react-dom.min.js"></script>
    <script src="/umi.js"></script>
    <script src="/layouts.js"></script>
    <script src="/p__blogs__detail__detail.js"></script>
  

</body></html>