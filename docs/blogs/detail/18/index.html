<!--
 * @Date: 2022-01-20 14:27:07
 * @LastEditors: lzj
 * @LastEditTime: 2022-01-21 16:41:33
 * @FilePath: \qianduan.shop\front\src\pages\document.ejs
--><!DOCTYPE html><html><head><title data-react-helmet="true">mysql添加索引后导致cpu飙升问题记录 - 前端网</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2087076429727327" crossorigin="anonymous"></script>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="/umi.css">
    <link rel="stylesheet" href="/layouts.chunk.css">
    <link rel="stylesheet" href="/p__blogs__detail__detail.chunk.css">
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.18
    </script>
    <title>文章详情</title>
  <meta data-react-helmet="true" name="description" content="mysql,索引,生产环境中给某个表（三百多万1.4G数据）加索引导致cpu飙升至95+%，问题排查及解决"><meta data-react-helmet="true" name="keywords" content="mysql,索引">
</head>

  <body>
    <div id="root"><header class="header___2_57M"><img alt="farmerLZJ" class="title___MhkPP" src="/static/logo.68ff92ec.png"/></header><div style="width:100%;position:relative;top:0;z-index:999"><nav class="nav___3wfA1"><a href="https://izejun.com/blogs" class="item___AqKVH active___1THnk">Blog</a></nav></div><div class="content___2QN8t"><div class="content___1G4Bw"><article><h1>mysql添加索引后导致cpu飙升问题记录</h1>

<h2>背景</h2>

<p>新加的功能某个数据接口查询慢，经排查是查询一个第三方绑定数据表慢，所以向数据库添加索引以提高查询速度，但是在添加后服务器CPU直接从20+%直接飙升至95+%,数据库连接数也飞涨，结果当然就不用说了，直接导致日志入库失败，数据查询超时，影响现有业务。</p>

<h2>问题排查</h2>

<p>首先考虑做了什么操作导致的问题，因为问题出现是在添加索引后出现的，所以首先考虑的是添加的索引有问题，由于同时添加了几个索引，不知道是哪个出了问题。 </p>

<p>我们尝试删除所有新加的索引，但是服务器CPU拉满了，任何操作都做不了，这就很蛋疼。</p>

<p>我们的数据库使用的是AWS的RDS，它提供了performace insight的功能，可以查看Top 10耗时的操作，我们看到新添加索引的表查询非常慢，大量sql语句等待执行。 </p>

<p>现在想让mysql能够执行我们的删除索引的命令，所以我们尝试临时升级mysql的配置，但是没有什么用，升级后CPU也是直接95+%，还是无法执行删除索引操作。</p>

<p>最后无奈，只能将慢查询所在的业务接口暂时停掉（<strong>注：我们这里的服务器主要是日志记录，所以综合考量暂时停一下影响不大</strong>）， 等CPU降下来后，执行索引删除操作，恢复出问题之前的状态。</p>

<h2>索引的问题</h2>

<p>回过头来再看索引的问题，添加的几个索引中，有一个索引其实是有问题的，问题索引的数据值分布很少，这样的索引过滤行很差，这样的索引就很容易引起CPU飙升。</p>

<p>具体的分析可参考：&lt;a href=&quot;http://mysql.taobao.org/monthly/2015/10/03&quot; rel=&quot;nofollow&quot; target=&quot;_blank&quot;&gt;http://mysql.taobao.org/monthly/2015/10/03&lt;/a&gt; ,这里不做详细阐述。</p>

<h2>总结</h2>

<p>1.合理的使用索引</p>

<p>2.对生产环境的操作一定要经过压测，这里我们就只是在测试环境添加后没有出现问题就直接上生产环境，这个流程就出现了问题。</p></article><div><span class="ant-tag ant-tag-geekblue">#<span>mysql</span></span><span class="ant-tag ant-tag-volcano">#<span>索引</span></span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><ins class=" adsbygoogle" style="display:block;text-align:center;width:100%;height:90px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="9331479126" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="container___8WoUM"><p class="title___3k8xL">Online Tools</p><div class="tool_tags___1ccK5"><span class="ant-tag ant-tag-blue tool_tag___1JT6M">JSON Formater</span><span class="ant-tag ant-tag-cyan tool_tag___1JT6M">MD5</span><span class="ant-tag ant-tag-error tool_tag___1JT6M">timestamps</span><span class="ant-tag ant-tag-green tool_tag___1JT6M">Cron Expresstion</span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div></div></div><footer class="footer___3wR6c">©2021 farmerlzj 提供技术支持 | 联系我们：farmerlzj@163.com |<!-- --> <a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">蜀ICP备2021025378号-1</a></footer><div class="ant-back-top"></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="https://cloud.qianduan.shop/react.min.js"></script>
    <script src="https://cloud.qianduan.shop/react-dom.min.js"></script>
    <script src="/umi.js"></script>
    <script src="/layouts.js"></script>
    <script src="/p__blogs__detail__detail.js"></script>
  

</body></html>