<!DOCTYPE html><html><head><title data-react-helmet="true">nodejs PM2 延时退出 - 前端网</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="baidu-site-verification" content="code-TlaecuFEx5">
    <meta name="sogou_site_verification" content="wMb3kHjFi6">
    <meta name="shenma-site-verification" content="19dfe33fcd6f20294164ba6738d0e102_1634534936">
    <meta name="360-site-verification" content="e943e2d7714355d2d1af8f36b12c41f9">
    <meta name="baidu_union_verify" content="6f7381d4136832e99f86da0d67739a46">
    <meta name="bytedance-verification-code" content="d+FL9L0/4KxPwFbqXgmT">

    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2087076429727327"
    crossOrigin="anonymous"></script> -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="/umi.css">
    <link rel="stylesheet" href="/layouts.chunk.css">
    <link rel="stylesheet" href="/p__blogs__detail__detail.chunk.css">
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.18
    </script>
    <title>文章详情</title>
  <meta data-react-helmet="true" name="description" content="前端网,node,pm2,优雅退出,在日常开发过程中，我们经常会用到 pm2 来起到服务，甚至会用 watch 来实现热更新。这种模式并不适合用在生产环境中，因为 pm2 零延时重启，会导致正在处理的请求直接被销毁，如果数据库没加事务，可能会导致数据库的数据不完整，我们可以利用--kill-timeout 参数延时退出，保证正在处理的请求正常结束"><meta data-react-helmet="true" name="keywords" content="前端网,node,pm2,优雅退出">
</head>

  <body>
    <div id="root"><header class="header___2_57M"><img alt="farmerLZJ" class="title___MhkPP" src="/static/logo.68ff92ec.png"/></header><div style="width:100%;position:relative;top:0;z-index:999"><nav class="nav___3wfA1"><a href="https://izejun.com/blogs" class="item___AqKVH active___1THnk">博客</a></nav></div><div class="content___2QN8t"><div class="content___1G4Bw"><header><a href="https://izejun.com/" class="back___26SyS undefined"> <!-- -->首页</a> <!-- -->/<a href="https://izejun.com/blogs" class="back___26SyS undefined"> <!-- -->博客</a></header><article><h1>nodejs PM2 延时退出</h1>

<p>在日常开发过程中，我们经常会用到 pm2 来起到服务，甚至会用 watch 来实现热更新。</p>

<p>但上面这种模式并不适合用在生产环境中，因为 pm2 零延时重启，会导致正在处理的请求直接被销毁，如果数据库没加事务，可能会导致数据库的数据不完整。</p>

<p>处理方法是延时 kill，参数是--kill-timeout。</p>

<p>在启动的app.js中添加 SIGINT 的监听，并在回调中用剩余的timeout时间处理数据。</p>

<p><code>
process.on(&#39;SIGINT&#39;, function() {
   db.stop(function(error) {
     process.exit(error ? 1 : 0)
   })
})
</code></p>

<p>启动方式如下：
<code>
pm2 start app.js --kill-timeout 3000
</code></p>

<p>重载就会触发。</p>

<p><code>
pm2 reload
</code></p>

<h2>实际问题</h2>

<p>一般使用 pm2，我们是希望 pm2 给我们提供负载均衡，每次 pull 好代码，reload 一下就能升级到最新的服务，而不需要从 Nginx 上下手。但是默认情况下 pm2 直接重启会导致正在处理的请求丢失。所以我们希望 PM2 在重启前，可以先通知 App，并给足够的时间让 App 处理完正在处理的请求，并且不再接收新的请求，然后再重启服务。</p>

<p>我们可以把上面的例子改成这样。
<code>
process.on(&#39;SIGINT&#39;, function() {
    global.app.running = false;
    db.stop(function(err) {
        process.exit(err ? 1 : 0)
   })
})
</code></p>

<p>global.app.running 为整个服务的全局变量，只要服务启动就赋值为true，并且在所有路由拦截器中增加判断逻辑：只要true时才接收请求，这样就能保证当global.app.running为false时，正在处理的请求不会被销毁，所有后来进入的请求都失败，从而保证数据库完整性。</p>

<p>但是这种拦截方式太过于粗暴，只是保证数据库完整，但是依然达不到平滑，平滑升级还有很多路要走。</p>

<h2>参考链接</h2>

<p><a href="https://pm2.keymetrics.io/docs/usage/signals-clean-restart/">Graceful Stop</a></p></article><div><span class="ant-tag ant-tag-geekblue">#<span>node</span></span><span class="ant-tag ant-tag-volcano">#<span>pm2</span></span><span class="ant-tag ant-tag-error">#<span>优雅退出</span></span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><ins class=" adsbygoogle" style="display:block;text-align:center;width:100%;height:90px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="9331479126" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="container___8WoUM"><p class="title___3k8xL">Online Tools</p><div class="tool_tags___1ccK5"><span class="ant-tag ant-tag-blue tool_tag___1JT6M">JSON Formater</span><span class="ant-tag ant-tag-cyan tool_tag___1JT6M">MD5</span><span class="ant-tag ant-tag-error tool_tag___1JT6M">timestamps</span><span class="ant-tag ant-tag-green tool_tag___1JT6M">Cron Expresstion</span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div></div></div><footer class="footer___3wR6c">©2021 farmerlzj 提供技术支持 | 联系我们：farmerlzj@163.com |<!-- --> <a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">蜀ICP备2021025378号-1</a></footer><div class="ant-back-top"></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="https://cloud.qianduan.shop/react.min.js"></script>
    <script src="https://cloud.qianduan.shop/react-dom.min.js"></script>
    <script src="/umi.js"></script>
    <script src="/layouts.js"></script>
    <script src="/p__blogs__detail__detail.js"></script>
  

</body></html>