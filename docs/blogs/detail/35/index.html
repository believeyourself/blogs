<!--
 * @Date: 2022-01-20 14:27:07
 * @LastEditors: lzj
 * @LastEditTime: 2022-01-21 16:41:33
 * @FilePath: \qianduan.shop\front\src\pages\document.ejs
--><!DOCTYPE html><html><head><title data-react-helmet="true">umi SSR 打包配置优化 - 前端网</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2087076429727327" crossorigin="anonymous"></script>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="/umi.css">
    <link rel="stylesheet" href="/layouts.chunk.css">
    <link rel="stylesheet" href="/p__blogs__detail__detail.chunk.css">
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.18
    </script>
    <title>文章详情</title>
  <meta data-react-helmet="true" name="description" content="umi,ssr,我这里有 SEO 的需求，所以需要做 SSR ,本文主要记录 umi ssr(服务端渲染)配置如何优化，仅记录本人实践过程中所用到的配置优化，仅供参考。"><meta data-react-helmet="true" name="keywords" content="umi,ssr">
</head>

  <body>
    <div id="root"><header class="header___2_57M"><img alt="farmerLZJ" class="title___MhkPP" src="/static/logo.68ff92ec.png"/></header><div style="width:100%;position:relative;top:0;z-index:999"><nav class="nav___3wfA1"><a href="https://izejun.com/blogs" class="item___AqKVH active___1THnk">Blog</a></nav></div><div class="content___2QN8t"><div class="content___1G4Bw"><article><h1>umi SSR 打包配置优化</h1>

<p>我这里有 SEO 的需求，所以需要做 SSR ,本文主要记录 umi ssr(服务端渲染)配置如何优化，仅记录本人实践过程中所用到的配置优化，仅供参考。</p>

<h2>开发环境</h2>

<p>win 10 + React 17 + umi 3.5.18 + node 14.15.1</p>

<h2>如何查看打包后包体大小及各依赖大小</h2>

<p>package.json 中配置命令
<code>
scripts:{
    ...
    &quot;analyze&quot;: &quot;cross-env UMI_ENV=prod ANALYZE=1 umi build&quot;
    ...
}
</code>
执行 npm run annalyze 就会输出包分析结果。</p>

<h2>umi 配置(.umirc.ts 或者 config.ts)</h2>

<h3>1. 开启服务端渲染</h3>

<p><code>
    ssr:{}
</code></p>

<h3>2.调整 splitChunks 策略，减少整体尺寸</h3>

<p>项目中使用了 antd 第三方依赖，可通过 splitChunks 配置调整公共依赖的提取策略。</p>

<p><code>
export default {
  dynamicImport: {},
  chunks: [&#39;vendors&#39;, &#39;umi&#39;],
  chainWebpack: function (config, { webpack }) {
    config.merge({
      optimization: {
        splitChunks: {
          chunks: &#39;all&#39;,
          minSize: 30000,
          minChunks: 3,
          automaticNameDelimiter: &#39;.&#39;,
          cacheGroups: {
            vendor: {
              name: &#39;vendors&#39;,
              test({ resource }) {
                return /[\\/]node_modules[\\/]/.test(resource);
              },
              priority: 10,
            },
          },
        },
      }
    });
  },
}
</code></p>

<h3>3.如果开发过程中热更新慢或者修改代码后增量编译，可调整 SourceMap 生成方式</h3>

<p><code></code>`
// 禁用 sourcemap
export default {
  devtool: false,
};</p>

<p>// 或者</p>

<p>// 使用最低成本的 sourcemap 生成方式，默认是 cheap-module-source-map
export default {
  devtool: &#39;eval&#39;,
};</p>

<p><code></code>`</p>

<h3>4.配置 externals 将大尺寸依赖从外部引入，减少编译消耗</h3>

<p>比如：react 、react-dom 、charts等</p>

<p><code></code>`
export default {
  // 配置 external
  externals: {
    &#39;react&#39;: &#39;window.React&#39;,
    &#39;react-dom&#39;: &#39;window.ReactDOM&#39;,
  },</p>

<p>  // 引入被 external 库的 scripts
  // 区分 development 和 production，使用不同的产物
  scripts: process.env.NODE_ENV === &#39;development&#39; ? [
    &#39;https://gw.alipayobjects.com/os/lib/react/16.13.1/umd/react.development.js&#39;,
    &#39;https://gw.alipayobjects.com/os/lib/react-dom/16.13.1/umd/react-dom.development.js&#39;,
  ] : [
    &#39;https://gw.alipayobjects.com/os/lib/react/16.13.1/umd/react.production.min.js&#39;,
    &#39;https://gw.alipayobjects.com/os/lib/react-dom/16.13.1/umd/react-dom.production.min.js&#39;,
  ],
}
<code></code>`</p>

<p><strong>注意：</strong></p>

<p>如果要支持 IE10 或以下，external react 还需要额外引入补丁，比如 &lt;a href=&quot;https://gw.alipayobjects.com/os/lib/alipay/react16-map-set-polyfill/1.0.2/dist/react16-map-set-polyfill.min.js&quot; target=&quot;_blank&quot; rel=&quot;nofollow&quot;&gt;https://gw.alipayobjects.com/os/lib/alipay/react16-map-set-polyfill/1.0.2/dist/react16-map-set-polyfill.min.js&lt;/a&gt;
如果 external antd，需同时 external 额外的 moment、react 和 react-dom，并在 antd 前引入。</p>

<h3>5.开启按需加载</h3>

<p><code>
dynamicImport: {},
</code></p>

<h3>6.根据项目情况自行判断是否开启预渲染</h3>

<p>预渲染会给每个页面输入 html, 一般静态网站适合使用。</p>

<p><code>
exportStatic: {},
</code></p>

<h3>7. 静态资源使用CDN, 通过 publicPath 配置静态资源 CDN 地址。</h3>

<p><code>
publicPath:&quot;https://www.cdn.com/&quot;
</code></p>

<h2>参考链接</h2>

<p>编译提速的配置参考：&lt;a href=&quot;https://umijs.org/zh-CN/guide/boost-compile-speed#%E9%85%8D%E7%BD%AE-externals&quot; rel=&quot;nofollow&quot; target=&quot;_blank&quot;&gt; umi 如何做编译提速&lt;/a&gt;</p></article><div><span class="ant-tag ant-tag-geekblue">#<span>umi</span></span><span class="ant-tag ant-tag-volcano">#<span>ssr</span></span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><ins class=" adsbygoogle" style="display:block;text-align:center;width:100%;height:90px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="9331479126" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="container___8WoUM"><p class="title___3k8xL">Online Tools</p><div class="tool_tags___1ccK5"><span class="ant-tag ant-tag-blue tool_tag___1JT6M">JSON Formater</span><span class="ant-tag ant-tag-cyan tool_tag___1JT6M">MD5</span><span class="ant-tag ant-tag-error tool_tag___1JT6M">timestamps</span><span class="ant-tag ant-tag-green tool_tag___1JT6M">Cron Expresstion</span></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div style="text-align:center;height:300px"><ins class=" adsbygoogle" style="display:inline-block;width:250px;height:300px" data-ad-client="ca-pub-2087076429727327" data-ad-slot="7022357395" data-ad-layout="" data-ad-layout-key="" data-ad-format="auto" data-full-width-responsive="false"></ins></div></div></div><footer class="footer___3wR6c">©2021 farmerlzj 提供技术支持 | 联系我们：farmerlzj@163.com |<!-- --> <a href="https://beian.miit.gov.cn/" rel="nofollow" target="_blank">蜀ICP备2021025378号-1</a></footer><div class="ant-back-top"></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="https://cloud.qianduan.shop/react.min.js"></script>
    <script src="https://cloud.qianduan.shop/react-dom.min.js"></script>
    <script src="/umi.js"></script>
    <script src="/layouts.js"></script>
    <script src="/p__blogs__detail__detail.js"></script>
  

</body></html>